<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/html" lang="pl">
<head>
  <meta charset="UTF-8">
  <script type="module" src="./songbook.js"></script>
  <link rel="stylesheet" href="./song.css"/>
  <link rel="stylesheet" href="./ch.css"/>
  <link rel="icon" type="image/png" href="./favicon.png" />
  <script>
    function init() {
      const urlParams = new URLSearchParams(window.location.search);
  
      const {baseUrl,branch,file,user} = parseParams();

      const loadUrl = urlParams.get('load') ? urlParams.get('load') : baseUrl ? `${baseUrl}/users/${user}/changes/${branch}/${file}` : null;

      const commitOnLoad = urlParams.get('commitOnLoad');
      const newFile = urlParams.get('new');
      const songEditor = document.getElementsByTagName("song-editor")[0];
      songEditor.setAttribute("git", branch && branch.trim() != '');
      if (loadUrl) {
        songEditor.setAttribute("title", "Wczytywanie ...");
        fetch(loadUrl, {credentials: 'include', method: 'GET', redirect: 'manual'})
            .then( (response) => {
              console.log("Fetched: " + JSON.stringify(response));
              
              // Handle redirect to login (CORS error prevention)
              if (response.type === 'opaqueredirect' || response.status === 0) {
                handleAuthRedirect(loadUrl, songEditor);
                return null;
              }
              
              if (response.status == 404 && newFile == "maybe") {
                songEditor.New();
                return null;
              }
              if (response.status != 200) {
                songEditor.setAttribute("title", "Nie udało się otworzyć pliku do edycji.");
                return null;
              }
              return response.text();
            })
            .then((txt) => {
              if (txt == null) {
                return;
              }
              if (!songEditor.Load(txt)) {
                songEditor.setAttribute("title", "Wczytywanie się nie powiodło :(");
                return;
              }
              if (commitOnLoad) {
                // The goal is to mark the file that is being touched to prevent deletion and
                // to distinguish user's changes from automatic format change.
                const title = songEditor.getAttribute("title");
                const msg = `Piosenka ${title}: Initial`;
                const ser = songEditor.Serialize();
                if (txt !== ser) {
                  commitInternal(songEditor, ser, msg);
                }
              }
            })
            .catch((error) => {
              console.error("Fetch error:", error);
              if (error.message.includes('CORS') || error.message.includes('NetworkError')) {
                handleAuthRedirect(loadUrl, songEditor);
              } else {
                songEditor.setAttribute("title", "Błąd wczytywania pliku");
              }
            });
      } else {
        songEditor.New();
      }
      songEditor.addEventListener("git:commit", async (e) => {
         await commit(e.target);
      } );
      songEditor.addEventListener("git:commitAndPublish", (e)=>commitAndPublish(e) );

      const topNav = document.getElementById("topnav");
      for (const nav of [document.getElementById("topnav"), document.getElementById("bottomnav")]) {
        if (baseUrl) {
          nav.innerHTML = `<a href="/">[Piosenki]</a> <a href="${baseUrl}/users/me/changes">[Inne rozpoczęte edycje]</a>`;
          nav.hidden = false;
        } else {
          nav.innerHTML = '';
          nav.hidden = true;
        }
      }
    }

    function handleAuthRedirect(originalUrl, songEditor) {
      const {baseUrl} = parseParams();
      const authUrl = `${baseUrl}/auth?returnTo=${encodeURIComponent(window.location.href)}`;
      
      songEditor.setAttribute("title", "Wymagane logowanie");
      
      // Create a prominent login notice
      const loginNotice = document.createElement("div");
      loginNotice.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        border: 3px solid #007bff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        z-index: 10000;
        text-align: center;
        max-width: 500px;
      `;
      
      loginNotice.innerHTML = `
        <h2>Musisz się zalogować</h2>
        <p>Aby kontynuować edycję, zaloguj się przez GitHub.</p>
        <p>Za chwilę zostaniesz przekierowany do strony logowania...</p>
        <button id="loginBtn" style="
          background: #007bff;
          color: white;
          border: none;
          padding: 10px 20px;
          font-size: 16px;
          border-radius: 5px;
          cursor: pointer;
          margin-top: 10px;
        ">Zaloguj się teraz</button>
      `;
      
      document.body.appendChild(loginNotice);
      
      // Auto-redirect after 3 seconds or on button click
      const redirectToAuth = () => {
        window.location.href = authUrl;
      };
      
      document.getElementById('loginBtn').addEventListener('click', redirectToAuth);
      setTimeout(redirectToAuth, 3000);
    }

    function parseParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        baseUrl: urlParams.get('baseUrl'),
        branch: urlParams.get('branch'),
        file: urlParams.get('file'),
        user: urlParams.get('user')
      }
    }

    function notice(txt, owner=null) {
      const notice = document.createElement("div");
      notice.classList.add("notice");
      notice.innerText=txt;

      setTimeout(() => {
        notice.remove();
      }, 2000)

      if (!owner) {
        document.getElementsByTagName("BODY")[0].insertBefore(notice, null);
      } else {
        owner.parentNode.insertBefore(notice, owner.nextSibling);
      }
    }

    async function commitInternal(songbook, serialized, msg) {
      try {
        const config = {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'text/xml',
          },
          body: serialized
        }
        const {baseUrl,branch,file,user} = parseParams();
        const response = await fetch(`${baseUrl}/users/${user}/changes/${branch}/${file}?msg=${encodeURIComponent(msg)}`, config)
        if (response.ok) {
          songbook.MarkAsCommitted(serialized);
          return true;
        } else if (response.status === 401 || response.status === 403) {
          handleAuthRedirect(null, songbook);
          return false;
        } else {
          alert("Zapis się nie powiódł. Czy jesteś podlączony do internetu ?");
          console.warn(response);
          return false;
        }
      } catch (error) {
        console.error(error);
        if (error.message && (error.message.includes('CORS') || error.message.includes('NetworkError'))) {
          handleAuthRedirect(null, document.getElementsByTagName("song-editor")[0]);
        } else {
          alert(JSON.stringify(error));
        }
        return false;
      }
    }

    async function commit(songbook) {
      const {serialized, changed, title} = songbook.SerializeWithChange();//document.getElementsByTagName("song-editor")[0].Serialize();

      if (!changed) {
        notice("Brak nowych zmian", songbook);
        return true; // To taki sukces.
      }

      const {branch} = parseParams();

      console.log(serialized);
      if (branch) {
        let msg = prompt("Wprowadź, proszę, krótki opis ostatnich zmian", `...`);
        if (!msg) {
          return false;
        }
        msg = `Piosenka ${title}: ` + msg;
        const ci = commitInternal(songbook, serialized, msg)
        notice("Zapisano", songbook);
        return ci
      }
      return false;
    }

    async function commitAndPublish(e) {
      if (await commit(e.target)) {
        const {baseUrl,branch,user} = parseParams();
        window.location = `${baseUrl}/users/${user}/changes/${branch}` + ':publish'
      }
    }

  </script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
</head>
<body onload="init()">
  <div id="topnav"></div>
  <h1>Edytor piosenek</h1>
  <song-editor></song-editor>
  <div id="bottomnav"></div>
</body>
</html>
